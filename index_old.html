<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메리츠 암통치 내비게이터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        :root { --meritz-red: #EF3B24; --meritz-gray: #6D6E71; }
        body { font-family: 'Pretendard', sans-serif; background-color: #F8F9FA; color: #1a1a1a; }
        .proposal-card { background: white; border-top: 12px solid var(--meritz-red); border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); margin-top: 60px; }
        .header-logo { position: absolute; top: 25px; left: 30px; height: 35px; z-index: 50; }
        .upload-zone { border: 2px dashed #E2E8F0; background-color: #FDFDFD; transition: all 0.3s; cursor: pointer; }
        .upload-zone:hover { border-color: var(--meritz-red); background-color: #FFF9F9; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #FCFCFC; }
        .accordion-content.active { max-height: 800px; border-bottom: 1px solid #FEE2E2; }
        .amount-highlight { color: var(--meritz-red); font-weight: 900; }
        .badge { display: inline-block; padding: 2px 10px; background: #FFF0F0; color: var(--meritz-red); border-radius: 99px; font-size: 0.7rem; font-weight: 800; }
    </style>
</head>
<body class="py-12 px-6 relative">

    <img src="ci.png" alt="Meritz Logo" class="header-logo">

    <div class="max-w-4xl mx-auto proposal-card overflow-hidden">
        <div class="p-12 text-center border-b border-gray-50">
            <h1 class="text-3xl font-black mb-2 tracking-tighter">나의 암 보장 <span style="color:var(--meritz-red)">지능형 리포트</span></h1>
            <p class="text-gray-400 font-bold uppercase text-sm tracking-widest">Meritz Cancer Navigation System</p>
        </div>

        <div class="p-10">
            <div id="drop-zone" class="upload-zone p-16 text-center rounded-3xl mb-12" onclick="document.getElementById('pdf-upload').click()">
                <div class="mb-5 text-red-200">
                    <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                </div>
                <p class="text-xl font-extrabold text-gray-700">가입제안서 PDF를 여기에 업로드하세요</p>
                <input type="file" id="pdf-upload" class="hidden" accept=".pdf" onchange="analyzePDF(event)">
            </div>

            <div id="result-table" class="hidden">
                <div class="flex items-center mb-8">
                    <span class="w-2 h-8 bg-red-500 mr-4 rounded-full"></span>
                    <h2 class="text-2xl font-black text-gray-900">나의 보장 한도 리포트</h2>
                </div>
                <div class="rounded-3xl border border-red-50 overflow-hidden shadow-sm bg-white">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-[10px] font-black text-gray-400 uppercase tracking-widest border-b">
                            <tr>
                                <th class="p-5 text-center w-24">구분</th>
                                <th class="p-5">보장 항목</th>
                                <th class="p-5 text-right">보장 금액 (최대)</th>
                                <th class="p-5 w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="analysis-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const BENEFIT_MAP = {
            "기본형": { "1억": 1000, "8천": 750, "4천": 500 },
            "실속형": { "7천": 1000, "5천": 750, "3천": 500, "1천": 250 },
            "비급여II": { "1억": 1000, "7천": 750, "4천": 500 }
        };

        async function analyzePDF(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('analysis-body').innerHTML = '<tr><td colspan="4" class="p-20 text-center text-red-500 font-bold animate-pulse">합산 보장액을 산출 중입니다...</td></tr>';
            document.getElementById('result-table').classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        fullText += content.items.map(item => item.str).join("  ") + " \n ";
                    }
                    const cleanText = fullText.replace(/\s/g, "");
                    const report = performKeywordAnalysis(cleanText);
                    renderResults(report);
                } catch (e) { alert("분석 중 오류 발생!"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function performKeywordAnalysis(text) {
            const findAmt = (keywords) => {
                if (!keywords.every(kw => text.includes(kw))) return 0;
                const lastKw = keywords[keywords.length - 1];
                const idx = text.indexOf(lastKw);
                const sub = text.substring(idx, idx + 200);
                const m = sub.match(/([0-9,]{4,11})/);
                if (m) {
                    let v = parseInt(m[1].replace(/,/g, ""));
                    return v >= 10000 ? Math.floor(v/10000) : v;
                }
                return 0;
            };

            const raw = {
                basic_limit: findAmt(["암통합", "기본형"]),
                ts_26: findAmt(["26종", "전이포함", "유사암제외"]),
                targeted: findAmt(["표적항암"]),
                immuno: findAmt(["면역항암"]),
                heavy: findAmt(["중입자"]),
                proton: findAmt(["양성자"]),
                davinci: findAmt(["다빈치", "로봇"])
            };

            const getBaseAmt = (limit) => {
                if (limit >= 10000) return 1000;
                if (limit >= 7000) return 1000;
                if (limit >= 4000) return 500;
                return 0;
            };

            const base = getBaseAmt(raw.basic_limit); // '항암방사선약물' 금액
            const ts26 = raw.ts_26 > 0 ? 1000 : 0; // 26종 항암 고정 1천만 원
            
            let res = [];

            // 1. 암 수술(급여)
            if (base > 0) {
                res.push({ cat: "수술", title: "일반암 수술비 (매회)", amt: base, 
                    details: `• 기본 수술비: ${base}만 원\n• 가입 한도: ${raw.basic_limit.toLocaleString()}만 원`, note: "매회 정액 지급되는 가장 기초적인 수술 보장입니다." });
            }

            // 2. 다빈치로봇 수술 (기본수술 + 다빈치)
            if (raw.davinci > 0) {
                res.push({ cat: "로봇수술", title: "다빈치로봇 암 수술비", amt: base + 1000, 
                    details: `• 기본 수술비: ${base}만 원\n• 다빈치 특약: 1,000만 원`, note: "기본 수술비와 중복 합산되어 보장받으실 수 있습니다." });
            }

            // 3. 26종 항암 (단독 표시)
            if (ts26 > 0) {
                res.push({ cat: "26종항암", title: "26종 항암방사선/약물 (각각)", amt: ts26, 
                    details: `• 26종 항암 가입금액: 1,000만 원`, note: "방사선과 약물 치료 시 각각 독립적으로 정액 지급됩니다." });
            }

            // 4. 표적항암 (항암방사선약물 + 26종 + 표적)
            if (raw.targeted > 0) {
                res.push({ cat: "항암치료", title: "표적항암 치료 시 총액", amt: base + ts26 + 3000, 
                    details: `• 항암방사선약물: ${base}만\n• 26종항암(약물): ${ts26}만\n• 표적항암특약: 3,000만`, note: "항암 약물 관련 모든 보장을 합산한 최대 보장액입니다." });
            }

            // 5. 면역항암 (항암방사선약물 + 26종 + 표적 + 면역)
            if (raw.immuno > 0) {
                res.push({ cat: "항암치료", title: "면역항암 치료 시 총액", amt: base + ts26 + 3000 + 3000, 
                    details: `• 표적항암 합계: ${base + ts26 + 3000}만\n• 면역항암특약: 3,000만`, note: "메리츠만의 꼬리에 꼬리를 무는 중복 합산 보장입니다." });
            }

            // 6. 양성자 치료 (항암방사선약물 + 26종 + 양성자)
            if (raw.proton > 0) {
                res.push({ cat: "최첨단치료", title: "항암 양성자 치료 시 총액", amt: base + ts26 + 3000, 
                    details: `• 항암방사선약물: ${base}만\n• 26종항암(방사선): ${ts26}만\n• 양성자특약: 3,000만`, note: "고가의 양성자 치료비 부담을 획기적으로 줄여줍니다." });
            }

            // 7. 중입자 치료 (항암방사선약물 + 26종 + 중입자)
            if (raw.heavy > 0) {
                res.push({ cat: "최첨단치료", title: "항암 중입자 치료 시 총액", amt: base + ts26 + 5000, 
                    details: `• 항암방사선약물: ${base}만\n• 26종항암(방사선): ${ts26}만\n• 중입자특약: 5,000만`, note: "꿈의 암 치료로 불리는 중입자 치료를 완벽하게 대비합니다." });
            }

            return res;
        }

        function renderResults(data) {
            const tbody = document.getElementById('analysis-body');
            tbody.innerHTML = data.map((item, i) => `
                <tr class="hover:bg-red-50 cursor-pointer border-b border-gray-100 transition-colors" onclick="toggleAccordion(${i})">
                    <td class="p-6 text-center"><span class="badge">${item.cat}</span></td>
                    <td class="p-6">
                        <div class="font-extrabold text-gray-800 text-lg">${item.title}</div>
                        <div class="text-[10px] text-red-400 font-bold mt-1 uppercase">Click for Breakdown ▼</div>
                    </td>
                    <td class="p-6 text-right amount-highlight">
                        <span class="text-3xl font-black">${item.amt.toLocaleString()}</span><span class="text-sm font-bold ml-1">만 원</span>
                    </td>
                    <td class="p-6 text-center">
                        <svg id="icon-${i}" class="w-5 h-5 text-gray-300 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </td>
                </tr>
                <tr>
                    <td colspan="4" class="p-0">
                        <div id="detail-${i}" class="accordion-content px-12">
                            <div class="py-10 flex gap-10 border-t border-red-50">
                                <div class="flex-1">
                                    <p class="text-[10px] font-black text-gray-300 uppercase mb-4 tracking-widest">Calculation Detail</p>
                                    <div class="space-y-3 font-bold text-sm text-gray-600">
                                        ${item.details.split('\n').map(l => `<div class="flex justify-between"><span>${l.split(':')[0]}</span><span class="text-gray-900">${l.split(':')[1]||''}</span></div>`).join('')}
                                    </div>
                                </div>
                                <div class="w-1/3 bg-red-50 p-6 rounded-3xl border border-red-100">
                                    <p class="text-[10px] font-black text-red-500 mb-2 uppercase tracking-widest">Manager Tip</p>
                                    <p class="text-sm text-red-800 leading-relaxed font-bold">${item.note}</p>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join("");
        }

        function toggleAccordion(i) {
            const content = document.getElementById(`detail-${i}`);
            const icon = document.getElementById(`icon-${i}`);
            const isActive = content.classList.contains('active');
            document.querySelectorAll('.accordion-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.transition-transform').forEach(el => el.style.transform = 'rotate(0deg)');
            if (!isActive) { content.classList.add('active'); icon.style.transform = 'rotate(180deg)'; }
        }
    </script>
</body>
</html>